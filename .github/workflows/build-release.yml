name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  FLUTTER_VERSION: '3.32.2'

jobs:
  # ============================================
  # Build Windows Application
  # ============================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Enable Windows Desktop Support
        run: flutter config --enable-windows-desktop
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Windows Release
        run: flutter build windows --release
      
      - name: Download SQLite3 DLL
        run: |
          # Try to download SQLite3 DLL from official source
          # SQLite version format: 3.51.1 = 3510100
          $success = $false
          
          # Try sqlite.org first (2025 directory for latest versions)
          $urls = @(
            "https://www.sqlite.org/2025/sqlite-dll-win-x64-3510100.zip",
            "https://www.sqlite.org/2024/sqlite-dll-win-x64-3470200.zip",
            "https://www.sqlite.org/2024/sqlite-dll-win-x64-3460100.zip"
          )
          
          foreach ($url in $urls) {
            try {
              Write-Host "Trying: $url"
              Invoke-WebRequest -Uri $url -OutFile "sqlite3.zip" -TimeoutSec 30
              if (Test-Path "sqlite3.zip") {
                Expand-Archive -Path "sqlite3.zip" -DestinationPath "sqlite3_temp" -Force
                if (Test-Path "sqlite3_temp/sqlite3.dll") {
                  Copy-Item -Path "sqlite3_temp/sqlite3.dll" -Destination "build/windows/x64/runner/Release/" -Force
                  Write-Host "Successfully downloaded sqlite3.dll from: $url"
                  $success = $true
                  break
                }
              }
            } catch {
              Write-Host "Failed to download from: $url - $_"
              continue
            }
          }
          
          if (-not $success) {
            Write-Error "Failed to download sqlite3.dll from any source!"
            exit 1
          }
        shell: pwsh
      
      - name: Create Windows Distribution Package
        run: |
          # Create distribution folder
          New-Item -ItemType Directory -Force -Path "dist/windows"
          
          # Copy the entire Release folder contents (includes all DLLs and data folder)
          Copy-Item -Path "build/windows/x64/runner/Release/*" -Destination "dist/windows/" -Recurse -Force
          
          # Verify critical files exist
          if (!(Test-Path "dist/windows/flutter_iptv.exe")) {
            Write-Error "flutter_iptv.exe not found!"
            exit 1
          }
          if (!(Test-Path "dist/windows/flutter_windows.dll")) {
            Write-Error "flutter_windows.dll not found!"
            exit 1
          }
          if (!(Test-Path "dist/windows/data")) {
            Write-Error "data folder not found!"
            exit 1
          }
          if (!(Test-Path "dist/windows/sqlite3.dll")) {
            Write-Error "sqlite3.dll not found!"
            exit 1
          }
          
          # List contents for debugging
          Write-Host "Windows package contents:"
          Get-ChildItem -Path "dist/windows/" -Recurse | ForEach-Object { Write-Host $_.FullName }
        shell: pwsh
      
      - name: Create Inno Setup Script
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          if ([string]::IsNullOrEmpty($version)) { $version = "1.0.0" }
          
          $issContent = @"
          [Setup]
          AppName=FlutterIPTV
          AppVersion=$version
          AppPublisher=FlutterIPTV
          DefaultDirName={autopf}\FlutterIPTV
          DefaultGroupName=FlutterIPTV
          OutputDir=.
          OutputBaseFilename=flutteriptv-Windows-x64-Setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64
          PrivilegesRequired=lowest
          
          [Files]
          Source: "dist\windows\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          
          [Icons]
          Name: "{group}\FlutterIPTV"; Filename: "{app}\flutter_iptv.exe"
          Name: "{group}\Uninstall FlutterIPTV"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\FlutterIPTV"; Filename: "{app}\flutter_iptv.exe"; Tasks: desktopicon
          
          [Tasks]
          Name: "desktopicon"; Description: "Create a desktop shortcut"; GroupDescription: "Additional icons:"
          
          [Run]
          Filename: "{app}\flutter_iptv.exe"; Description: "Launch FlutterIPTV"; Flags: nowait postinstall skipifsilent
          "@
          
          $issContent | Out-File -FilePath "installer.iss" -Encoding UTF8
          Write-Host "Inno Setup script created"
        shell: pwsh
      
      - name: Build Windows Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
        shell: pwsh
      
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: flutteriptv-Windows-x64-Setup.exe
          retention-days: 5

  # ============================================
  # Build Android Mobile APK
  # ============================================
  build-android-mobile:
    name: Build Android Mobile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Android APK (Split by ABI)
        run: flutter build apk --release --split-per-abi
      
      - name: Rename APKs for Mobile
        run: |
          mkdir -p dist/android-mobile
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk dist/android-mobile/flutteriptv-Android-Mobile-armeabi-v7a.apk
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/android-mobile/flutteriptv-Android-Mobile-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk dist/android-mobile/flutteriptv-Android-Mobile-x86_64.apk
      
      - name: Build Universal APK
        run: flutter build apk --release
      
      - name: Copy Universal APK
        run: |
          cp build/app/outputs/flutter-apk/app-release.apk dist/android-mobile/flutteriptv-Android-Mobile-universal.apk
      
      - name: Upload Android Mobile Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-mobile-release
          path: dist/android-mobile/
          retention-days: 5

  # ============================================
  # Build Android TV APK
  # ============================================
  build-android-tv:
    name: Build Android TV
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Android TV APK
        run: |
          # Build with TV flag enabled
          flutter build apk --release --dart-define=IS_TV=true --split-per-abi
      
      - name: Rename APKs for TV
        run: |
          mkdir -p dist/android-tv
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk dist/android-tv/flutteriptv-AndroidTV-armeabi-v7a.apk
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/android-tv/flutteriptv-AndroidTV-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk dist/android-tv/flutteriptv-AndroidTV-x86_64.apk
      
      - name: Build Universal TV APK
        run: flutter build apk --release --dart-define=IS_TV=true
      
      - name: Copy Universal TV APK
        run: |
          cp build/app/outputs/flutter-apk/app-release.apk dist/android-tv/flutteriptv-AndroidTV-universal.apk
      
      - name: Upload Android TV Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-tv-release
          path: dist/android-tv/
          retention-days: 5

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create Release
    needs: [build-windows, build-android-mobile, build-android-tv]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: ./release-assets/
      
      - name: Download Android Mobile Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-mobile-release
          path: ./release-assets/android-mobile/
      
      - name: Download Android TV Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-tv-release
          path: ./release-assets/android-tv/
      
      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "TAG=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Commit Messages
        id: commits
        run: |
          # Get all tags sorted by version
          TAGS=$(git tag -l 'v*' --sort=-v:refname)
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          
          # Find the previous tag
          PREV_TAG=""
          FOUND_CURRENT=false
          for tag in $TAGS; do
            if [ "$FOUND_CURRENT" = true ]; then
              PREV_TAG=$tag
              break
            fi
            if [ "$tag" = "$CURRENT_TAG" ]; then
              FOUND_CURRENT=true
            fi
          done
          
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREV_TAG"
          
          # Initialize category files
          echo "" > fixes.txt
          echo "" > features.txt
          echo "" > improvements.txt
          echo "" > others.txt
          
          if [ -n "$PREV_TAG" ]; then
            # Get commits between previous tag and current
            git log --pretty=format:"%s" $PREV_TAG..$CURRENT_TAG 2>/dev/null | while read -r line; do
              # Skip merge commits and empty lines
              if [[ -z "$line" ]] || [[ "$line" == Merge* ]]; then
                continue
              fi
              
              # Categorize commits based on conventional commit prefixes
              if [[ "$line" == fix:* ]] || [[ "$line" == fix\(*\):* ]] || [[ "$line" == *ä¿®å¤* ]] || [[ "$line" == *fix* ]]; then
                # Extract message after prefix
                msg=$(echo "$line" | sed 's/^fix[:(][^)]*[)]*: *//' | sed 's/^fix: *//')
                echo "- ğŸ› $msg" >> fixes.txt
              elif [[ "$line" == feat:* ]] || [[ "$line" == feat\(*\):* ]] || [[ "$line" == *æ–°å¢* ]] || [[ "$line" == *æ·»åŠ * ]]; then
                msg=$(echo "$line" | sed 's/^feat[:(][^)]*[)]*: *//' | sed 's/^feat: *//')
                echo "- âœ¨ $msg" >> features.txt
              elif [[ "$line" == perf:* ]] || [[ "$line" == refactor:* ]] || [[ "$line" == style:* ]] || [[ "$line" == *ä¼˜åŒ–* ]] || [[ "$line" == *æ”¹è¿›* ]]; then
                msg=$(echo "$line" | sed 's/^[a-z]*[:(][^)]*[)]*: *//' | sed 's/^[a-z]*: *//')
                echo "- âš¡ $msg" >> improvements.txt
              else
                echo "- ğŸ“ $line" >> others.txt
              fi
            done
          else
            echo "- ğŸ‰ Initial release" > others.txt
          fi
          
          # Combine all categories
          echo "### ğŸ› Bug ä¿®å¤" > commits.txt
          if [ -s fixes.txt ] && [ "$(cat fixes.txt | tr -d '[:space:]')" != "" ]; then
            cat fixes.txt >> commits.txt
          else
            echo "_æ— _" >> commits.txt
          fi
          
          echo "" >> commits.txt
          echo "### âœ¨ æ–°åŠŸèƒ½" >> commits.txt
          if [ -s features.txt ] && [ "$(cat features.txt | tr -d '[:space:]')" != "" ]; then
            cat features.txt >> commits.txt
          else
            echo "_æ— _" >> commits.txt
          fi
          
          echo "" >> commits.txt
          echo "### âš¡ ä¼˜åŒ–æ”¹è¿›" >> commits.txt
          if [ -s improvements.txt ] && [ "$(cat improvements.txt | tr -d '[:space:]')" != "" ]; then
            cat improvements.txt >> commits.txt
          else
            echo "_æ— _" >> commits.txt
          fi
          
          echo "" >> commits.txt
          echo "### ğŸ“ å…¶ä»–æ›´æ–°" >> commits.txt
          if [ -s others.txt ] && [ "$(cat others.txt | tr -d '[:space:]')" != "" ]; then
            cat others.txt >> commits.txt
          else
            echo "_æ— _" >> commits.txt
          fi
          
          echo "Got commits:"
          cat commits.txt
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          # Read commits
          COMMITS=$(cat commits.txt)
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="${{ steps.version.outputs.TAG }}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"
          
          cat << 'EOFHEADER' > release_notes.md
          ## ğŸ“º FlutterIPTV VERSION_PLACEHOLDER
          
          EOFHEADER
          
          # Replace version placeholder
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" release_notes.md
          
          # Add commits section
          cat commits.txt >> release_notes.md
          
          cat << EOFBODY >> release_notes.md
          
          ---
          
          ### ğŸ“¥ ä¸‹è½½ Downloads
          
          #### ğŸ–¥ï¸ Windows
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | [flutteriptv-Windows-x64-Setup.exe](${BASE_URL}/flutteriptv-Windows-x64-Setup.exe) | Windows 64ä½å®‰è£…åŒ… |
          
          #### ğŸ“± Android æ‰‹æœºç‰ˆ
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | [flutteriptv-Android-Mobile-arm64-v8a.apk](${BASE_URL}/flutteriptv-Android-Mobile-arm64-v8a.apk) | 64ä½ ARM è®¾å¤‡ï¼ˆæ¨èï¼Œé€‚ç”¨äºå¤§å¤šæ•°ç°ä»£æ‰‹æœºï¼‰ |
          | [flutteriptv-Android-Mobile-armeabi-v7a.apk](${BASE_URL}/flutteriptv-Android-Mobile-armeabi-v7a.apk) | 32ä½ ARM è®¾å¤‡ï¼ˆæ—§æ¬¾æ‰‹æœºï¼‰ |
          | [flutteriptv-Android-Mobile-x86_64.apk](${BASE_URL}/flutteriptv-Android-Mobile-x86_64.apk) | x86_64 æ¨¡æ‹Ÿå™¨ |
          | [flutteriptv-Android-Mobile-universal.apk](${BASE_URL}/flutteriptv-Android-Mobile-universal.apk) | é€šç”¨ç‰ˆï¼ˆæ–‡ä»¶è¾ƒå¤§ï¼Œå…¼å®¹æ‰€æœ‰è®¾å¤‡ï¼‰ |
          
          #### ğŸ“º Android TV ç”µè§†ç‰ˆ
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | [flutteriptv-AndroidTV-arm64-v8a.apk](${BASE_URL}/flutteriptv-AndroidTV-arm64-v8a.apk) | 64ä½ ARM ç”µè§†è®¾å¤‡ï¼ˆFire TV Stick 4Kã€Shield TV ç­‰ï¼‰ |
          | [flutteriptv-AndroidTV-armeabi-v7a.apk](${BASE_URL}/flutteriptv-AndroidTV-armeabi-v7a.apk) | 32ä½ ARM ç”µè§†è®¾å¤‡ï¼ˆæ—§æ¬¾ Fire TVï¼‰ |
          | [flutteriptv-AndroidTV-x86_64.apk](${BASE_URL}/flutteriptv-AndroidTV-x86_64.apk) | x86_64 ç”µè§†æ¨¡æ‹Ÿå™¨ |
          | [flutteriptv-AndroidTV-universal.apk](${BASE_URL}/flutteriptv-AndroidTV-universal.apk) | é€šç”¨ç”µè§†ç‰ˆï¼ˆæ–‡ä»¶è¾ƒå¤§ï¼Œå…¼å®¹æ‰€æœ‰ç”µè§†è®¾å¤‡ï¼‰ |
          
          ---
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - æ”¯æŒ M3U/M3U8 æ’­æ”¾åˆ—è¡¨
          - é«˜è´¨é‡è§†é¢‘æ’­æ”¾ï¼ˆHLSã€DASHã€RTMPï¼‰
          - é¢‘é“åˆ†ç»„å’Œæ”¶è—åŠŸèƒ½
          - EPG ç”µå­èŠ‚ç›®å•æ”¯æŒ
          - Android TV å®Œæ•´é¥æ§å™¨å¯¼èˆªæ”¯æŒ
          - æ˜äº®/æš—é»‘ä¸»é¢˜åˆ‡æ¢
          
          ### ğŸ“‹ å®‰è£…è¯´æ˜
          
          **Windows:**
          1. ä¸‹è½½ \`flutteriptv-Windows-x64-Setup.exe\`
          2. è¿è¡Œå®‰è£…ç¨‹åºå¹¶æŒ‰æç¤ºæ“ä½œ
          3. ä»å¼€å§‹èœå•æˆ–æ¡Œé¢å¿«æ·æ–¹å¼å¯åŠ¨
          
          **Android æ‰‹æœº:**
          1. ä¸‹è½½é€‚åˆæ‚¨è®¾å¤‡çš„ APK æ–‡ä»¶
          2. å¦‚æœ‰æç¤ºï¼Œè¯·å¯ç”¨"å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨"
          3. å®‰è£…å¹¶æ‰“å¼€åº”ç”¨
          
          **Android TV:**
          1. ä¸‹è½½é€‚åˆæ‚¨ç”µè§†çš„ APK æ–‡ä»¶
          2. é€šè¿‡ USBã€ADB æˆ–æ–‡ä»¶ç®¡ç†å™¨å®‰è£…
          3. ä»ç”µè§†åº”ç”¨åˆ—è¡¨å¯åŠ¨
          
          ---
          
          > ğŸ’¡ **æç¤º:** ARM64 è®¾å¤‡å»ºè®®ä½¿ç”¨ \`arm64-v8a\` ç‰ˆæœ¬ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚
          EOFBODY
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: flutteriptv ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-assets/flutteriptv-Windows-x64-Setup.exe
            release-assets/android-mobile/flutteriptv-Android-Mobile-arm64-v8a.apk
            release-assets/android-mobile/flutteriptv-Android-Mobile-armeabi-v7a.apk
            release-assets/android-mobile/flutteriptv-Android-Mobile-x86_64.apk
            release-assets/android-mobile/flutteriptv-Android-Mobile-universal.apk
            release-assets/android-tv/flutteriptv-AndroidTV-arm64-v8a.apk
            release-assets/android-tv/flutteriptv-AndroidTV-armeabi-v7a.apk
            release-assets/android-tv/flutteriptv-AndroidTV-x86_64.apk
            release-assets/android-tv/flutteriptv-AndroidTV-universal.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
